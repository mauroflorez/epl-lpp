<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPL Score Predictor</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            padding: 2rem;
            margin: 0;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background-color: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #37003c;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        h2 {
            color: #37003c;
            border-bottom: 2px solid #37003c;
            padding-bottom: 0.5rem;
            margin-top: 1.5rem;
        }

        .matchday-badge {
            display: inline-block;
            background: linear-gradient(135deg, #37003c 0%, #00ff85 100%);
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
        }

        th,
        td {
            padding: 0.7rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 0.9rem;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .score {
            font-weight: bold;
            color: #37003c;
        }

        .actual-score {
            font-weight: bold;
            color: #007bff;
        }

        .pending {
            color: #999;
            font-style: italic;
        }

        .correct {
            color: #28a745;
        }

        .incorrect {
            color: #dc3545;
        }

        .prediction-box {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .clickable-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .clickable-row:hover {
            background-color: #f0f7ff;
        }

        /* Accuracy Banner */
        .accuracy-box {
            text-align: center;
            padding: 1rem;
            margin-bottom: 1.5rem;
            background: linear-gradient(135deg, #37003c 0%, #00ff85 100%);
            border-radius: 8px;
            color: white;
        }

        /* Heatmap Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-header h3 {
            margin: 0;
            color: #37003c;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        .heatmap {
            display: grid;
            grid-template-columns: 40px repeat(6, 1fr);
            gap: 2px;
            font-size: 0.85rem;
        }

        .heatmap-cell {
            padding: 8px 4px;
            text-align: center;
            border-radius: 4px;
            font-weight: 500;
        }

        .heatmap-header {
            background: #37003c;
            color: white;
            font-weight: 600;
        }

        .heatmap-row-header {
            background: #00ff85;
            color: #37003c;
            font-weight: 600;
        }

        .heatmap-label {
            font-size: 0.8rem;
            color: #666;
            text-align: center;
            margin-top: 0.5rem;
        }

        @media (max-width: 768px) {

            th,
            td {
                padding: 0.5rem;
                font-size: 0.8rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Premier League Predictions</h1>

        <div class="accuracy-box">
            <span style="font-size: 1.1rem;">Winner Prediction Accuracy:</span>
            <span id="accuracy-value"
                style="font-size: 1.5rem; font-weight: bold; margin-left: 0.5rem;">Loading...</span>
            <span id="accuracy-detail" style="font-size: 0.9rem; margin-left: 0.5rem; opacity: 0.9;"></span>
        </div>

        <!-- Last Matchday Results -->
        <h2>Last Matchday <span class="matchday-badge" id="past-matchday-badge">#23</span></h2>
        <div class="prediction-box">
            <table id="past-table">
                <thead>
                    <tr>
                        <th>Match</th>
                        <th>Pred</th>
                        <th>H/D/A %</th>
                        <th>Actual</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Current Matchday -->
        <h2>Current Matchday <span class="matchday-badge" id="current-matchday-badge">#24</span></h2>
        <p style="font-size: 0.85rem; color: #888; margin-top: -0.5rem;">Click a row to see probability heatmap</p>
        <div class="prediction-box">
            <table id="current-table">
                <thead>
                    <tr>
                        <th>Match</th>
                        <th>Date</th>
                        <th>Pred</th>
                        <th>H/D/A %</th>
                        <th>Actual</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="last-updated" style="color: #999; font-size: 0.85rem; margin-top: 1rem;"></div>

        <!-- How It Works -->
        <div
            style="margin-top: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #37003c;">
            <h2 style="color: #37003c; margin-top: 0;">How It Works</h2>
            <p style="color: #666; line-height: 1.6;">
                We use a <strong>Poisson regression model</strong> trained on the current season to predict expected
                goals.
                The H/D/A % column shows the probability of Home Win / Draw / Away Win based on the Poisson
                distribution.
                Click any row to see the full probability heatmap for all scorelines.
            </p>
            <p style="color: #999; font-size: 0.85rem; margin-top: 1rem; font-style: italic;">
                ⚠️ This is an experimental project for learning purposes.
            </p>
        </div>
    </div>

    <!-- Heatmap Modal -->
    <div class="modal-overlay" id="heatmap-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Probability Heatmap</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="heatmap-label" style="margin-bottom: 0.3rem;"><strong>Away Goals →</strong></div>
            <div class="heatmap" id="heatmap-grid"></div>
            <div class="heatmap-label"><strong>↑ Home Goals</strong></div>
        </div>
    </div>

    <script>
        let currentMatchdayData = [];

        async function loadData() {
            try {
                // Load Current Matchday Predictions
                const predResponse = await fetch('predictions.json');
                if (predResponse.ok) {
                    const data = await predResponse.json();
                    currentMatchdayData = data.predictions || data;
                    const matchday = data.matchday || '24';
                    document.getElementById('current-matchday-badge').textContent = `#${matchday}`;
                    populateCurrentTable(currentMatchdayData);
                }

                // Load Past Results
                const resultResponse = await fetch('past_results.json');
                if (resultResponse.ok) {
                    const data = await resultResponse.json();
                    const results = data.results || data;
                    const matchday = data.matchday || '23';
                    document.getElementById('past-matchday-badge').textContent = `#${matchday}`;
                    populatePastTable(results);
                }

                // Load Accuracy
                const accResponse = await fetch('accuracy.json');
                if (accResponse.ok) {
                    const acc = await accResponse.json();
                    document.getElementById('accuracy-value').textContent = acc.accuracy + '%';
                    document.getElementById('accuracy-detail').textContent =
                        `(${acc.correct}/${acc.evaluated} correct, ${acc.pending} pending)`;
                } else {
                    document.getElementById('accuracy-value').textContent = 'N/A';
                }

                document.getElementById('last-updated').textContent = `Last updated: ${new Date().toLocaleDateString()}`;
            } catch (error) {
                console.error("Error loading data:", error);
            }
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr + 'T12:00:00');
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            return `${day}/${month}`;
        }

        function formatWinProbs(winProbs) {
            if (!winProbs) return '-';
            const h = winProbs.H;
            const d = winProbs.D;
            const a = winProbs.A;
            const maxProb = Math.max(h, d, a);
            const hStyle = h === maxProb ? 'font-weight:bold;color:#28a745;' : 'color:#666;';
            const dStyle = d === maxProb ? 'font-weight:bold;color:#ffc107;' : 'color:#666;';
            const aStyle = a === maxProb ? 'font-weight:bold;color:#dc3545;' : 'color:#666;';
            return `<span style="${hStyle}">${h}</span> / <span style="${dStyle}">${d}</span> / <span style="${aStyle}">${a}</span>`;
        }

        function populatePastTable(data) {
            const tableBody = document.querySelector('#past-table tbody');
            tableBody.innerHTML = '';

            data.forEach(item => {
                const row = document.createElement('tr');
                const home = item.Home || item.HomeTeam;
                const away = item.Away || item.AwayTeam;

                row.innerHTML = `
                    <td>${home} vs ${away}</td>
                    <td class="score">${item.PredictedScore}</td>
                    <td style="font-size:0.85em;">${formatWinProbs(item.WinProbs)}</td>
                    <td class="actual-score">${item.Actual || item.ActualScore}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function populateCurrentTable(data) {
            const tableBody = document.querySelector('#current-table tbody');
            tableBody.innerHTML = '';

            data.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = 'clickable-row';
                row.onclick = () => showHeatmap(index);

                const actual = item.Actual || '-';
                const actualClass = actual === '-' ? 'pending' : 'actual-score';

                row.innerHTML = `
                    <td>${item.HomeTeam} vs ${item.AwayTeam}</td>
                    <td>${formatDate(item.MatchDate)}</td>
                    <td class="score">${item.PredictedScore}</td>
                    <td style="font-size:0.85em;">${formatWinProbs(item.WinProbs)}</td>
                    <td class="${actualClass}">${actual}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function showHeatmap(index) {
            const match = currentMatchdayData[index];
            if (!match || !match.ProbMatrix) {
                alert('Probability data not available for this match.');
                return;
            }

            document.getElementById('modal-title').textContent = `${match.HomeTeam} vs ${match.AwayTeam}`;
            const grid = document.getElementById('heatmap-grid');
            grid.innerHTML = '';

            // Header row
            grid.innerHTML += '<div class="heatmap-cell"></div>';
            for (let a = 0; a <= 5; a++) {
                grid.innerHTML += `<div class="heatmap-cell heatmap-header">${a}</div>`;
            }

            // Data rows
            for (let h = 0; h <= 5; h++) {
                grid.innerHTML += `<div class="heatmap-cell heatmap-row-header">${h}</div>`;
                for (let a = 0; a <= 5; a++) {
                    const key = `${h}-${a}`;
                    const prob = match.ProbMatrix[key] || 0;
                    const color = getHeatmapColor(prob);
                    grid.innerHTML += `<div class="heatmap-cell" style="background:${color};" title="${key}: ${prob}%">${prob}%</div>`;
                }
            }

            document.getElementById('heatmap-modal').classList.add('active');
        }

        function getHeatmapColor(prob) {
            if (prob < 3) return '#fee0e0';
            if (prob < 6) return '#fff3cd';
            if (prob < 10) return '#d4edda';
            if (prob < 15) return '#a8e6a8';
            return '#6fdc6f';
        }

        function closeModal() {
            document.getElementById('heatmap-modal').classList.remove('active');
        }

        document.getElementById('heatmap-modal').addEventListener('click', function (e) {
            if (e.target === this) closeModal();
        });
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') closeModal();
        });

        loadData();
    </script>
</body>

</html>