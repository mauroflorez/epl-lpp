<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPL Score Predictor</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            padding: 2rem;
            margin: 0;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            background-color: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #37003c;
            text-align: center;
            margin-bottom: 2rem;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .column h2 {
            color: #555;
            border-bottom: 2px solid #37003c;
            padding-bottom: 0.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        th,
        td {
            padding: 0.8rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
            font-size: 0.95rem;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .score {
            font-weight: bold;
            color: #37003c;
        }

        .actual-score {
            font-weight: bold;
            color: #007bff;
        }

        .prediction-box {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
        }

        /* Clickable prediction rows */
        .clickable-row {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .clickable-row:hover {
            background-color: #f0f7ff;
        }

        .clickable-row td:first-child::after {
            content: " üìä";
            font-size: 0.8em;
            opacity: 0.5;
        }

        /* Heatmap Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-header h3 {
            margin: 0;
            color: #37003c;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: #333;
        }

        /* Heatmap Grid */
        .heatmap-container {
            overflow-x: auto;
        }

        .heatmap {
            display: grid;
            grid-template-columns: 40px repeat(6, 1fr);
            gap: 2px;
            font-size: 0.85rem;
        }

        .heatmap-cell {
            padding: 8px 4px;
            text-align: center;
            border-radius: 4px;
            font-weight: 500;
        }

        .heatmap-header {
            background: #37003c;
            color: white;
            font-weight: 600;
        }

        .heatmap-row-header {
            background: #00ff85;
            color: #37003c;
            font-weight: 600;
        }

        .heatmap-label {
            font-size: 0.8rem;
            color: #666;
            text-align: center;
            margin-top: 0.5rem;
        }

        .heatmap-legend {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            font-size: 0.8rem;
            color: #666;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Premier League Predictions</h1>

        <div id="accuracy-box"
            style="text-align: center; padding: 1rem; margin-bottom: 1.5rem; background: linear-gradient(135deg, #37003c 0%, #00ff85 100%); border-radius: 8px; color: white;">
            <span style="font-size: 1.1rem;">Winner Prediction Accuracy:</span>
            <span id="accuracy-value"
                style="font-size: 1.5rem; font-weight: bold; margin-left: 0.5rem;">Loading...</span>
            <span id="accuracy-detail" style="font-size: 0.9rem; margin-left: 0.5rem; opacity: 0.9;"></span>
        </div>

        <div class="grid">
            <!-- Left Column: Past Results -->
            <div class="column">
                <h2>Last Round Results</h2>
                <div class="prediction-box">
                    <table id="past-table">
                        <thead>
                            <tr>
                                <th>Match</th>
                                <th>Predicted</th>
                                <th>Actual</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Right Column: Upcoming -->
            <div class="column">
                <h2>Upcoming Predictions</h2>
                <p style="font-size: 0.85rem; color: #888; margin-top: -0.5rem;">Click a row to see probability heatmap
                </p>
                <div class="prediction-box">
                    <table id="upcoming-table">
                        <thead>
                            <tr>
                                <th>Match</th>
                                <th>Pred</th>
                                <th>H/D/A %</th>
                                <th>xG</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="last-updated" id="last-updated"></div>

        <!-- Modeling Details Section -->
        <div
            style="margin-top: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #37003c;">
            <h2 style="color: #37003c; margin-top: 0;">How It Works</h2>

            <h3 style="font-size: 1rem; color: #555; margin-bottom: 0.5rem;">üìä The Model</h3>
            <p style="color: #666; line-height: 1.6; margin-bottom: 1rem;">
                We use a <strong>Poisson regression model</strong> to predict expected goals for each team.
                The model learns <em>team attack strength</em> and <em>defensive weakness</em> by analyzing
                how each team performs across all matches in the current season.
            </p>

            <h3 style="font-size: 1rem; color: #555; margin-bottom: 0.5rem;">‚öΩ Features Used</h3>
            <ul style="color: #666; line-height: 1.8; margin-bottom: 1rem; padding-left: 1.5rem;">
                <li><strong>Team Effects:</strong> Attack strength for home team, defensive weakness for opponent</li>
                <li><strong>League Position:</strong> Current standings in the table</li>
                <li><strong>Rolling Stats:</strong> Goals, shots, and shots on target (last 5 games)</li>
            </ul>

            <h3 style="font-size: 1rem; color: #555; margin-bottom: 0.5rem;">üîÑ Daily Updates</h3>
            <p style="color: #666; line-height: 1.6; margin-bottom: 1rem;">
                The model is <strong>retrained daily</strong> using all matches played so far this season.
                As more games are played, the model learns better estimates of each team's true strength.
            </p>

            <h3 style="font-size: 1rem; color: #555; margin-bottom: 0.5rem;">üìà Expected Goals (xG)</h3>
            <p style="color: #666; line-height: 1.6; margin-bottom: 0;">
                The xG column shows the model's expected goals for each team. For example, "1.5 - 0.8" means
                the home team is expected to score 1.5 goals on average, while the away team is expected to score 0.8.
                Click on any prediction to see the full probability heatmap for all scorelines!
            </p>

            <p style="color: #999; font-size: 0.85rem; margin-top: 1.5rem; font-style: italic;">
                ‚ö†Ô∏è This is an experimental project for learning purposes. Predictions should not be used for any real
                decisions.
            </p>
        </div>
    </div>

    <!-- Heatmap Modal -->
    <div class="modal-overlay" id="heatmap-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Probability Heatmap</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="heatmap-container">
                <div class="heatmap-label" style="margin-bottom: 0.3rem;"><strong>Away Goals ‚Üí</strong></div>
                <div class="heatmap" id="heatmap-grid"></div>
                <div class="heatmap-label"><strong>‚Üë Home Goals</strong></div>
            </div>
            <div class="heatmap-legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #fee;"></div> Low
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffa;"></div> Medium
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #8f8;"></div> High
                </div>
            </div>
        </div>
    </div>

    <script>
        let predictionsData = [];

        async function loadData() {
            try {
                // Load Upcoming
                const predResponse = await fetch('predictions.json');
                if (predResponse.ok) {
                    predictionsData = await predResponse.json();
                    populateTable('#upcoming-table tbody', predictionsData, false);
                }

                // Load Past Results
                const resultResponse = await fetch('past_results.json');
                if (resultResponse.ok) {
                    const results = await resultResponse.json();
                    populateTable('#past-table tbody', results, true);
                }

                // Load Accuracy
                const accResponse = await fetch('accuracy.json');
                if (accResponse.ok) {
                    const acc = await accResponse.json();
                    document.getElementById('accuracy-value').textContent = acc.accuracy + '%';
                    document.getElementById('accuracy-detail').textContent =
                        `(${acc.correct}/${acc.evaluated} correct, ${acc.pending} pending)`;
                } else {
                    document.getElementById('accuracy-value').textContent = 'N/A';
                }

                document.getElementById('last-updated').textContent = `Last updated: ${new Date().toLocaleDateString()}`;

            } catch (error) {
                console.error("Error loading data:", error);
            }
        }

        function populateTable(selector, data, isPast) {
            const tableBody = document.querySelector(selector);
            tableBody.innerHTML = '';

            data.forEach((item, index) => {
                const row = document.createElement('tr');

                const matchCell = document.createElement('td');
                matchCell.textContent = `${item.HomeTeam} vs ${item.AwayTeam}`;

                const predCell = document.createElement('td');
                predCell.className = 'score';
                predCell.textContent = item.PredictedScore;

                row.appendChild(matchCell);
                row.appendChild(predCell);

                if (isPast) {
                    const actualCell = document.createElement('td');
                    actualCell.className = 'actual-score';
                    actualCell.textContent = item.ActualScore;
                    row.appendChild(actualCell);
                } else {
                    // H/D/A probability column
                    const probCell = document.createElement('td');
                    probCell.style.fontSize = '0.85em';
                    if (item.WinProbs) {
                        const h = item.WinProbs.H;
                        const d = item.WinProbs.D;
                        const a = item.WinProbs.A;
                        // Highlight the most likely outcome
                        const maxProb = Math.max(h, d, a);
                        const hStyle = h === maxProb ? 'font-weight:bold;color:#28a745;' : 'color:#666;';
                        const dStyle = d === maxProb ? 'font-weight:bold;color:#ffc107;' : 'color:#666;';
                        const aStyle = a === maxProb ? 'font-weight:bold;color:#dc3545;' : 'color:#666;';
                        probCell.innerHTML = `<span style="${hStyle}">${h}</span> / <span style="${dStyle}">${d}</span> / <span style="${aStyle}">${a}</span>`;
                    } else {
                        probCell.textContent = '-';
                    }
                    row.appendChild(probCell);

                    // xG column
                    const xgCell = document.createElement('td');
                    xgCell.style.color = '#777';
                    xgCell.style.fontSize = '0.9em';
                    xgCell.textContent = `${Number(item.HomeGoals_Exp).toFixed(1)} - ${Number(item.AwayGoals_Exp).toFixed(1)}`;
                    row.appendChild(xgCell);

                    // Make row clickable for heatmap
                    row.className = 'clickable-row';
                    row.onclick = () => showHeatmap(index);
                }

                tableBody.appendChild(row);
            });
        }

        function showHeatmap(index) {
            const match = predictionsData[index];
            if (!match || !match.ProbMatrix) {
                alert('Probability data not available for this match.');
                return;
            }

            document.getElementById('modal-title').textContent =
                `${match.HomeTeam} vs ${match.AwayTeam}`;

            const grid = document.getElementById('heatmap-grid');
            grid.innerHTML = '';

            // Header row (Away goals 0-5)
            grid.innerHTML += '<div class="heatmap-cell"></div>'; // Empty corner
            for (let a = 0; a <= 5; a++) {
                grid.innerHTML += `<div class="heatmap-cell heatmap-header">${a}</div>`;
            }

            // Data rows
            for (let h = 0; h <= 5; h++) {
                // Row header (Home goals)
                grid.innerHTML += `<div class="heatmap-cell heatmap-row-header">${h}</div>`;

                for (let a = 0; a <= 5; a++) {
                    const key = `${h}-${a}`;
                    const prob = match.ProbMatrix[key] || 0;
                    const color = getHeatmapColor(prob);
                    grid.innerHTML += `<div class="heatmap-cell" style="background: ${color};" title="${h}-${a}: ${prob}%">${prob}%</div>`;
                }
            }

            document.getElementById('heatmap-modal').classList.add('active');
        }

        function getHeatmapColor(prob) {
            // Color scale: low (red-ish) -> medium (yellow) -> high (green)
            if (prob < 3) return '#fee0e0';
            if (prob < 6) return '#fff3cd';
            if (prob < 10) return '#d4edda';
            if (prob < 15) return '#a8e6a8';
            return '#6fdc6f';
        }

        function closeModal() {
            document.getElementById('heatmap-modal').classList.remove('active');
        }

        // Close modal on outside click
        document.getElementById('heatmap-modal').addEventListener('click', function (e) {
            if (e.target === this) closeModal();
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') closeModal();
        });

        loadData();
    </script>
</body>

</html>